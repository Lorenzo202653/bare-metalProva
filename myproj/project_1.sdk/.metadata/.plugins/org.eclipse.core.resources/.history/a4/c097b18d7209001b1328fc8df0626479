
#include "ov7670_diretto.h"


int init_ov7670_diretto(void) {
	XAxiDma_Config *CfgPtr;
	int Status;

	diretto_config = XOv7670_diretto_LookupConfig(XPAR_XOV7670_DIRETTO_0_DEVICE_ID);
	if (diretto_config == NULL)
		{
			perror("Device config not found in init_ov7670_diretto");
			return XST_FAILURE;
		}
	if (XOv7670_diretto_CfgInitialize(&diretto, diretto_config))
		{
			perror("Error init_ov7670_diretto");
			return XST_FAILURE;
		}

	CfgPtr = XAxiDma_LookupConfig(XPAR_AXI_DMA_0_DEVICE_ID);
		if (!CfgPtr) {
			xil_printf("No config found for %d\r\n", XPAR_AXI_DMA_0_DEVICE_ID);
			return XST_FAILURE;
		}

		Status = XAxiDma_CfgInitialize(&AxiDma, CfgPtr);
		if (Status != XST_SUCCESS) {
			xil_printf("Initialization failed %d\r\n", Status);
			return XST_FAILURE;
		}

		if(XAxiDma_HasSg(&AxiDma)){
			xil_printf("Device configured as SG mode \r\n");
			return XST_FAILURE;
		}


	return XST_SUCCESS;
}

int configue_ov7670_diretto(void) {
	XOv7670_diretto_EnableAutoRestart(&diretto);
	XOv7670_diretto_Start(&diretto);
	XAxiDma_IntrDisable(&AxiDma, XAXIDMA_IRQ_ALL_MASK,
								XAXIDMA_DEVICE_TO_DMA);
			XAxiDma_IntrDisable(&AxiDma, XAXIDMA_IRQ_ALL_MASK,
								XAXIDMA_DMA_TO_DEVICE);
	return XST_SUCCESS;
}

void dma_prova(){
	u8 *TxBufferPtr;

	int Status;
	int Index;
	TxBufferPtr = (u8 *)TX_BUFFER_BASE ;
	xil_printf("INZIO IL FOR \r\n");





			Status = XAxiDma_SimpleTransfer(&AxiDma,(UINTPTR) TxBufferPtr,
						MAX_PKT_LEN, XAXIDMA_DMA_TO_DEVICE);

			if (Status != XST_SUCCESS) {
				return XST_FAILURE;
			}

			while ((XAxiDma_Busy(&AxiDma,XAXIDMA_DEVICE_TO_DMA)) ||
				(XAxiDma_Busy(&AxiDma,XAXIDMA_DMA_TO_DEVICE))) {
					/* Wait */
			}
			xil_printf("INZIO IL TEST \r\n");
			Status = CheckData();
			if (Status != XST_SUCCESS) {
				return XST_FAILURE;
			}



}

 int CheckData(void)
{

	u8 *TxPacket;
	int Index = 0;
	u8 Value;

	TxPacket = (u8 *) TX_BUFFER_BASE;
	Value = TEST_START_VALUE;

	/* Invalidate the DestBuffer before receiving the data, in case the
	 * Data Cache is enabled
	 */
#ifndef __aarch64__
	Xil_DCacheInvalidateRange((UINTPTR)TxPacket, MAX_PKT_LEN);
#endif

	for(Index = 0; Index < MAX_PKT_LEN; Index++) {
		if (TxPacket[Index] != Value) {
			xil_printf("Data error %d: %x/%x\r\n",
			Index, (unsigned int)TxPacket[Index],
				(unsigned int)Value);

			return XST_FAILURE;
		}
		Value = (Value + 1) & 0xFF;
	}

	return XST_SUCCESS;
}

